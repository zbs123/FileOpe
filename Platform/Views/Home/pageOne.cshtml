@using Models;
@{
    Layout = "~/Views/Shared/_Head.cshtml";
    @Styles.Render("~/Content/css/page.css", "~/webuploader/webuploader.css", "~/Content/app.css", "~/Content/css/pageOne.css");
    @Scripts.Render("~/Scripts/upload/jquery-1.7.1.min.js", "~/webuploader/webuploader.js", "~/Scripts/upload/Kings.Uploader.js");
}

<style type="text/css">
    #viewck div {
        width: 20px;
        height: 20px;
        float: left;
        background-color: #cccccc;
        border: 1px solid #ffffff;
    }

    #viewck div.has {
        background-color: green;
        text-align: center;
    }

    #picker .webuploader-pick {
        height: 20px;
        width: 30px;
        padding: 6px 12px;
        display: block;
        background: #1E9FFF;
    }

    #picker {
        font-size: 14px;
        display: inline-block;
        line-height: 1.428571429;
        vertical-align: middle;
        margin: 0 12px 0 0;
        padding: 4px 10px;
        margin-right: -6px;
    }

    .webuploader-pick-hover {
        /*background: #C9C9C9;
           color: #C9C9C9;*/
        background-color: #C9C9C9;
    }

    .layui-table td:nth-child(2), .layui-table th:nth-child(2) {
        text-align: left;
    }
    /*部门人员*/
    #person {
        background: #3c4252;
    }

    #shareBox {
        border: none;
        margin-top: 10px;
        display: none;
    }

    #shareBox .layui-colla-title {
        height: 40px;
        line-height: 40px;
        background-color: #e4e4e4;
        text-indent: 20px;
        padding: 0;
        font-size: 14px;
        color: #4c4c4c;
    }

    #shareBox .layui-colla-title > i {
        right: 15px;
        color: #A7A7A7;
    }

    #shareBox .layui-colla-content > ul > li {
        height: 40px;
        line-height: 40px;
        background-color: #fff;
        text-indent: 30px;
        font-size: 14px;
        color: #4c4c4c;
        position: relative;
        cursor: pointer;
        border-bottom: 1px dashed #e6e6e6;
    }

    #shareBox .layui-colla-content > ul > li.active, #shareBox .layui-colla-content > ul > li:hover {
        color: #1e9fff;
        background: #eef5fe;
    }

    #shareBox .layui-colla-content > ul > li > i {
        position: absolute;
        right: 13px;
        top: 1px;
        color: #1e9fff;
        display: none;
    }

    #shareBox .searchBox {
        width: 50%;
        height: 32px;
        border-radius: 16px;
        background-color: #f1f2f4;
        display: inline-block;
        overflow: hidden;
        position: relative;
        left: 10px;
        margin: 35px auto 10px;
    }

    #shareBox .searchBox > input {
        width: 100%;
        height: 100%;
        border: none;
        padding-left: 0px;
        color: #999999;
        text-indent: 18px;
        font-size: 14px;
        background: #f3f3f3;
    }

    #shareBox .searchBox > i {
        position: absolute;
        top: 17px;
        right: 6px;
        color: #979797;
        font-size: 23px;
        color: #333333;
        line-height: 0;
        cursor: pointer;
    }

    h2 {
        margin-top: 0px;
        margin-bottom: 0px;
    }

    .layui-table-view {
        margin: 0px;
    }

    .layui-form-checkbox i {
        width: 14px;
    }
    .layui-form-checked, .layui-form-checked:hover {
        border-color: #1E9FFF;
    }

    .layui-form-checked[lay-skin=primary] i {
        border-color: #1E9FFF;
        background-color: #fff;
        color: #1E9FFF;
    }

    .layui-form-checkbox[lay-skin=primary]:hover i {
        border-color: #1E9FFF;
        color: #1E9FFF;
    }

    .layui-form-checked[lay-skin=primary]:hover i {
        border-color: #1E9FFF;
        background-color: #fff;
        color: #1E9FFF;
    }


    .grade-box ul li.active {
        background: #e6f0ff;
        font-size: 16px;
        color: #3088f7;
    }
    .layui-table-cell img{
        width:19px;
        height:22px;
    }
    
    /*.layui-table-cell span:first-child {
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
        overflow: hidden !important;
    }
    .layui-table-cell{
        padding-right:40px;
    }
    tr td:nth-child(2) .layui-table-cell{
        
    }*/
   .layui-table-body .layui-table-cell span:first-child {
        width: 90%;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
        display: block;
    }
    .toolBar{
        top:2px;
    }
    .desc {
        border-top-color: #666 !important;
    }
    .asc {
        border-bottom-color: #666 !important;
    }
   
</style>




@*<div class="content-pannel-buttons" style="border-bottom:1px solid #cccccc">
        @*<a onclick="" id="picker"><b class="p-icon-upload">选择文件</b></a>
        <button onclick="start()"><b class="p-icon-add">开始</b></button>
        <button onclick="stop()"><b class="p-icon-edit">暂停</b></button>
    </div>
    <div id="filesss" class="file">
    </div>
    <div id="thelist"></div>
    <div id="viewck" style="padding:15px;">
    </div>*@

<body class="body">
    <div class="layui-form" action="">
        @Html.Partial("~/Views/Shared/Top.cshtml")
        <div class="index-box" style="padding-top:80px;">
            @Html.Partial("~/Views/Shared/RoleLeft.cshtml", ViewData["page"] = "StudentList")
            <a href="javascript:void(0);" class="export-save-down layui-hide"><span id="spd"></span></a>
            <div class="right f-l ml-20">
                <div class="title">
                    <div class="t-l">文档管理</div>
                </div>
                <input type="hidden" id="token" value="@ViewBag.token" />
                <div class="table-box" style="margin-bottom:80px;">
                    @*<o class="text f-l pl-10">
                            共有<span id="countdata">--</span>条数据
                        </o>
                        <o class="option f-r">
                            <btn class="mr-10">
                                <a class="current" href="../Student?sguid=@ViewBag.Sguid">添加学生</a>
                                <a class="mr-5" id="more-option" data-is="0">
                                    批量操作 <i class="fa fa-angle-right"></i>
                                    <ul>
                                        <li data-com="disable">批量禁用</li>
                                        <li data-com="delete">批量删除</li>
                                    </ul>
                                </a>
                                <a id="import">导入数据</a>
                                <a id="export">导出数据</a>
                            </btn>
                        </o>*@

                    <div class="clearfix">

                        <div class="table-top clearfix">
                            <div class="btnsWrap" style="float:left;font-size: 16px;color: #666;">
                                共<span id="listcount">@ViewBag.filecount</span>条数据
                            </div>
                            <div class="fl btnsWrap" style="float:right;">
                                <a onclick="" id="picker">上传</a>
                                @*<a onclick="" id="test">测试</a>*@
                                <button class="layui-btn layui-btn-primary cf" data-type="createFile">
                                    新建文件夹
                                </button>
                                @*<button class="layui-btn layui-btn-primary" id="test" >
                                    新建
                                </button>*@
                                @*<button class="layui-btn layui-btn-primary down">
                                         下载
                                    </button>
                                    <button class="layui-btn layui-btn-primary delete">
                                         删除
                                    </button>
                                    <button class="layui-btn layui-btn-primary rename" data-type="resetName">
                                         重命名
                                    </button>*@
                                <div class="layui-btn-group btngroup layui-hide" style="margin-left:10px;">
                                    <button class="layui-btn layui-btn-primary addVotePeople">
                                        分享
                                    </button>
                                    <button class="layui-btn layui-btn-primary down">
                                        下载
                                    </button>
                                    <button class="layui-btn layui-btn-primary delete">
                                        删除
                                    </button>
                                   
                                    <button class="layui-btn layui-btn-primary rename" data-type="resetName">
                                        重命名
                                    </button>
                                    <button class="layui-btn layui-btn-primary" id="test1">
                                        测试
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="reminds" style="padding-left:276px;margin-top:-17px;margin-bottom:10px;">
                            <span class="layui-breadcrumb" id="breadcrumb" style="float:left;">
                                <a href="pageOne?token=@ViewBag.token">全部文件</a>
                                @foreach (var p in ViewBag.remindPath)
                                {
                                    <a href="pageOne?path=@p.Address&token=@ViewBag.token">@p.Name</a>
                                }
                            </span>
                            &nbsp;
                            @*已全部加载，共<span id="listcount">@ViewBag.filecount</span>个*@
                        </div>
                        <input type="hidden" id="filepath" value="@ViewBag.filepath" />
                        <input type="hidden" id="type" value="@ViewBag.type" />
                        <div class="table  pb-20 f-l">
                            <div class="grade-box f-l ml-15">
                                <a href="javascript:void(0);" class="export-save layui-hide"><span id="sp"></span></a>
                                <ul id="typelist">
                                    <li data-guid="0" data-name=""><i class="fa fa-caret-right"></i><font> 图片</font>  <span><b data-com="edit">编辑</b><b class="delete" data-com="delete">删除</b></span></li>
                                    <li data-guid="1" data-name=""><i class="fa fa-caret-right"></i><font> 文档</font>  <span><b data-com="edit">编辑</b><b class="delete" data-com="delete">删除</b></span></li>
                                    <li data-guid="2" data-name=""><i class="fa fa-caret-right"></i><font> 其他</font>  <span><b data-com="edit">编辑</b><b class="delete" data-com="delete">删除</b></span></li>

                                </ul>
                                <div class="add-grade ml-10 mt-10 hide">
                                    <input type="text" class="layui-input" id="grade-add-input" placeholder="请输入年级名称" maxlength="7" />
                                    <a title="确定" data-com="save">√</a>
                                    <a title="取消" data-com="cancel">×</a>
                                </div>
                            </div>
                            <div class="class-box f-l ml-10">
                                <div class="layui-hide" id="test" lay-filter="tableTest"></div>
                                <div id="demo2"></div>
                            </div>
                        </div>

                        <div class="noData layui-hide" id="noData">
                            <img src="/fileos/images/noData.png" alt="">
                            <p>您还没有上传过文件</p>
                        </div>

                    </div>

                    <!--上传弹出层-->
                    <div id="uploadBox">
                        <div class="warn">
                            <span>共<b id="filenums"></b>个文件，有<b id="filenum"></b>个文件上传成功</span>
                            @*<span class="fr">
                                <img src="images/warn.png" alt="" class="warnIcon fl">
                                <i class="fl" style="margin-right: 8px;">警告</i>
                                <i class="layui-icon closeWarn">&#x1006;</i>
                            </span>
                            <span class="tips">
                                严禁利用百度网盘上传、传播暴力恐怖、色情违法及其他违法信息，一经发现将严格按照相关法律法规处理。
                                <em></em>
                            </span>*@
                        </div>
                        <ul></ul>
                    </div>

                    @*分享弹出框*@
                    <section class="layi-cloose-box radius" id="shareBox" style="display: none;">
                        <div class="title"><span class="pl-20">选择用户</span><span class="f-r pr-20"><i class="layui-icon close_cloose" title="关闭">&#x1006;</i></span></div>
                        <div class="all-per ml-10 mt-10">
                            @*<div class="layui-form">
                                    <div class="layui-input-block" style="margin-left:0px !important;">
                                        <select name="interest" id="userType" lay-filter="user_type">
                                            <option value="0" selected="">按部门</option>
                                            <option value="1">按年级</option>
                                            <option value="2">按班级</option>

                                        </select>
                                    </div>
                                </div>*@
                            <div class="layi-search-box">
                                <input class="layui-input input-bd-1 pl-30" type="text" id="keyword" placeholder="输入用户姓名" />
                                <i class="layui-icon">&#xe615;</i>
                            </div>
                            <ul id="personlist">
                                @{ foreach (var item in ViewData["list"] as List<Role_User>)
                                    {
                                        <li>
                                            <a><i class="fa  fa-caret-right pl-5"></i> <span class="pl-5">@item.RoleName</span></a><div>
                                                @{ if (item.Users.Count > 0)
                                                    {
                                                        string uid = Request.Cookies["User"]["uguid"];
                                                        foreach (var i in item.Users)
                                                        {
                                                            if (i != null)
                                                            {
                                                                if (uid != i.Uid)
                                                                {

                                                                    <span data-c="0" data-uid="@i.Uid" data-name="@i.Name">@i.Name</span>
                                                                }

                                                            }


                                                        }
                                                    }
                                                }
                                            </div>
                                        </li>
                                                    }}


                            </ul>
                        </div>
                        <div class="cloose-per f-r mt-10 mr-10" id="wrap">
                            <ul></ul>
                        </div>
                        <div class="layi-btn text-r">
                            <a class="layui-btn layui-btn-sm layui-btn-primary mt-10 close_cloose">取消</a>
                            <a class="layui-btn layui-btn-sm layui-btn-normal mt-10" id="lay-confirm">确定</a>
                        </div>
                    </section>
                   
                    <div class="table  pb-20">

                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--搜索 start-->
    <div class="right-search show-btn"><i class="fa fa-search mt-10"></i></div>
    <div class="seach-right-box">
        <div class="title" id="close-box"><i class="layui-icon">&#x1006;</i> 数据筛选</div>
        <div class="seacher-body ml-10 layui-form">
            <div class="s-block mb-10">
                <span>文件名</span>
                <input type="text" class="s-input" placeholder="输入关键词搜索" id="r-search-name" />
            </div>
            <div class="s-block mb-10">
                <span>日期</span>
                <input type="text" class="s-input" id="r-search-date" placeholder="选择日期范围">
                <input type="hidden" id="start" />
                <input type="hidden" id="end" />
                @*<input type="text" class="s-input" placeholder="输入关键词搜索" id="r-search" />*@
            </div>
            <div class="s-block mb-10">
                <span>类型</span>
                <input type="text" class="s-input" placeholder="输入文件后缀搜索" id="r-search-type" />
            </div>

            <div class="s-btn-list">
                <a class="clean-btn" id="clean-btn">清除</a>
                <a class="layui-btn layui-btn-sm layui-btn-normal" id="seacher-btn">&nbsp;&nbsp;搜索&nbsp;&nbsp;</a>
            </div>

        </div>
    </div>
    <!--搜索 end-->
    @*<div class="right-search share-btn" style="top:700px;left:0px;"><i class="layui-icon" style="font-size:36px;">&#xe641;</i></div>*@
</body>

<!--文件图标添加-->
<script type="text/html" id="fileName">
    {{#  if(d.Type === '1'){ }}
    <span data-fileurl="{{ d.FileUrl }}" data-type="{{ d.Type }}"><img src="/fileos/images/wenjianjia.png" alt="">{{ d.Name  }}</span>
    <span class="toolBar fr"><i class="layui-icon">&#xe65f;</i></span>
    <ul class="toolList">
        <li class="down">下载</li>
        <li class="delete">删除</li>
        <li class="renameFile" lay-event="renameFile">重命名</li>
    </ul>
    {{#  } else if(d.Name === 'new') { }}
    <span class="newCreatebox">
        <img src="/fileos/images/wenjianjia.png" alt="">
        <input type="text"  placeholder="新建文件夹" class="newFile">
        <button class="layui-btn layui-btn-primary" lay-event="yes">
            <i class="layui-icon" style=" color: #1E9FFF;">&#xe605;</i>
        </button>
        <button class="layui-btn layui-btn-primary" lay-event="no">
            <i class="layui-icon" style="color: #1E9FFF;">&#x1006;</i>
        </button>
    </span>
    {{#  } else { }}
    <span data-fileurl="{{ d.FileUrl }}" data-type="{{ d.Type }}"><img src="../images/{{ d.Type }}.png" alt="">{{ d.Name }}</span>
    <span class="toolBar fr"><i class="layui-icon">&#xe65f;</i></span>
    <ul class="toolList">
        <li class="down">下载</li>
        <li class="delete">删除</li>
        <li class="renameFile" lay-event="renameFile">重命名</li>
    </ul>
    {{#  } }}
</script>
@Scripts.Render("~/Scripts/js/jquery.min.js", "~/Scripts/layui/layui.all.js")

<script>
    jQuery.ajax({
        type: "Post",
        url: "DeleteUp",
        data: {},
        success: function (data) {
            var res = JSON.parse(data);
        }
    });
    var errorFile = [];
    var successFile = [];
        var uploader = new Kings.Uploader().createFile({
            swf: '@Url.Content("~/webuploader/Uploader.swf")',
            server: '@Url.Content("UploaderProcess")',
            pick: '#picker',
            resize: false,
            fileSingleSizeLimit: 104857600,

        }, {
        beforeFileQueued: function (file) {
            var allext = '.png,.xls,.xlsx,.doc,.docx,.ppt,.pptx,.pdf,.txt,.zip,.wps,.dps,.et,.jpg,.bmp,.rar';
            if (allext.indexOf(file.ext.toLowerCase()) == -1) {
                layer.msg("上传的文件包含非法文件，将自动过滤！！！");
            }
            var reg = new RegExp('%', "g");
            var reg1 = new RegExp('#', "g");
            file.name = file.name.replace(reg, '!').replace(reg1,'!');
            if (file.size > 104857600) {
                errorFile.push(file.name);
            } else {
                successFile.push(file.name);
            }
        },
        fileQueued: function (file) {
            $("#filenums").html(successFile.length);
            file = file[0] || file;
            $("#uploadBox").find("ul").append('<li id="' + file.id + '"><span class="file-name"><img src="images/doc.png" alt="">' + file.name + '</span><span class="file-size">' + WebUploader.formatSize(file.size, 0, ['B', 'KB', 'MB']) + '</span><span class="file-path">' + $("#breadcrumb").find("a:last-child").text() + '</span><span class="file-status">等待上传...</span></li>');
            layer.open({
                type: 1,
                title: '上传完成',
                skin: 'layui-layer-shadow',
                offset: ['519px', $(document).width() - 635+'px'],
                shade: 0,
                maxmin: true,
                area: ['635px', '430px'], //宽高
                content: $("#uploadBox"),
                cancel: function (index, layero) {
                    $("#uploadBox").find("ul").each(function (item, index) {
                        if ($(this).find("span:last-child").text().indexOf("%") != -1 && $(this).find("span:last-child").text() != "100%") {
                            $(this).remove();
                        }

                    })
                    uploader.reset();
                    layer.close(index);
                    $("#uploadBox").hide();
                    return false;
                }
            });


        },
        uploadStart: function (file) {
        },
        uploadProgress: function (file, number) {
            var $li = $('#' + file.id);

            if ((number * 100).toFixed(2) == 100.00)
            {

                $li.find("span:last-child").html('<i class="layui-icon" style="color: #5CD992;">&#xe616;</i>');
            }
            else
            {
                $li.find("span:last-child").text((number * 100).toFixed(0)+"%");
            }
        },
        uploadFinished: function () {
            if ($("#filenum").html()) {
                var table = layui.table;
                table.reload('test', {
                    url: "getfile",
                    limit: 50,
                    where: {
                        path: $("#filepath").val()
                    },
                    done: function (res) {
                        jQuery("#listcount").text("");
                        jQuery("#listcount").text(res.count);
                        newArr = res.data;
                        if (res.count == 0) {
                            jQuery("#noData").removeClass("layui-hide");
                            jQuery(".layui-none").remove();
                            jQuery(".layui-table-page").remove();
                        } else {

                            jQuery("#noData").addClass("layui-hide");
                        }

                    }
                });
                uploader.reset();
                
            }
            
        },
        uploadSuccess: function (file) {
            var fc = $("#filenum").html() || 0;
            $("#filenum").html(parseInt(fc) + 1);
        },
        startUpload: function () {
            if (errorFile.length > 0) {
                //var msghtml = '';
                //for (var i = 0; i < errorFile.length; i++) {
                //    msghtml += errorFile + '文件大小超过100M，上传失败<br>';
                //}
                layer.msg("文件大小超过100M将自动过滤");
                errorFile = [];
            }

        },
        //文件上传暂停事件
        stopUpload: function () {
            console.log("stop")
        },
        error: function (type) {
            console.log(type)
            //if (type == "F_EXCEED_SIZE") {
            //    layer.msg("文件大小不能超过100M");
            //}
        }
     });
       
    function start() {
        uploader.upload();
    }
    function stop() {
        uploader.stop(true);
    }
   
    var is_asked = false;

    window.onbeforeunload =
        function (ev) {
            var e = ev || window.event;
            window.focus();
            if (!is_asked) {
                if (uploader.isInProgress()) {
                    is_asked = true;
                    var showstr = "CUSTOM_MESSAGE";
                    if (e) {  //for ie and firefox  
                        e.returnValue = showstr;
                    }
                    return showstr; //for safari and chrome  
                }
                
            } 
        };

    window.onfocus =
        function (ev) {
            if (is_asked) {
                uploader.retry();
                is_asked = false;
                //window.location.href = "http://www.baidu.com";
            }
        }  
    //////////////////////
    //表格数据
    var tableData = null;
    var newArr;
    $(window).resize(function () {
        if (tableData != null) {
            reloadTable(tableData)
        }
    });
    tableLayui();
    function reloadTable(data) {
        var table = layui.table;
        var res = JSON.parse(data);

        newArr = res.data;
        jQuery("#listcount").text("");
        jQuery("#listcount").text(res.count);
        var newContent = new Object();
        //获取当前系统日期
        var mydate = new Date();
        var date = "" + mydate.getFullYear() + "-";
        date += (mydate.getMonth() + 1) + "-";
        date += mydate.getDate();

        //选中的第几行
        var trIndex, oldName, imgSrc;

        if (newArr.length > 50) {
            //表格
            table.render({
                elem: '#test'
                , data: newArr
                , page: {

                    layout: ['count', 'prev', 'page', 'next']
                    , prev: '上一页'
                    , next: '下一页'
                    , count: newArr.length
                    , limit: 50
                    , theme: '#1E9FFF'
                }


                , cols: [[
                    { type: 'checkbox' }
                    , { field: 'Name', width: '50%', title: '文件名', sort: true, templet: '#fileName' }
                    , { field: 'Size', title: '大小', sort: true }
                    , { field: 'Date', title: '修改日期', sort: true, align: 'center' }

                ]]

                , done: function (res, curr, count) {
                    currpage = curr;
                    if (res.count == 0) {
                        jQuery("#noData").removeClass("layui-hide");
                        jQuery(".layui-none").remove();
                        jQuery(".layui-table-page").remove();
                    } else {

                        jQuery("#noData").addClass("layui-hide");
                    }
                }
                , id: "test"
            });
        }
        else {
            //表格
            table.render({
                elem: '#test'
                , data: newArr
                , limit: 50
                , cols: [[
                    { type: 'checkbox' }
                    , { field: 'Name', width: '50%', title: '文件名', sort: true, templet: '#fileName' }
                    , { field: 'Size', title: '大小', sort: true }
                    , { field: 'Date', title: '修改日期', sort: true, align: 'center' }

                ]]

                , done: function (res) {

                    if (res.count == 0) {
                        jQuery("#noData").removeClass("layui-hide");
                        jQuery(".layui-none").remove();
                        jQuery(".layui-table-page").remove();
                    } else {

                        jQuery("#noData").addClass("layui-hide");
                    }
                }
                , id: "test"
            });

        }
        jQuery("td[data-field='Name'] a").mouseover(function () {
            var that = this;
            var text = $(that).text();
            var t_w = $(that).width();
            var w = $(that).parent().width();
            if (t_w > w) {
                layer.tips(text, that, { tips: 3,time:4000 });
            }
        })
        //监听表格复选框选择
        table.on('checkbox(tableTest)', function (obj) {

            trIndex = obj.data.LAY_TABLE_INDEX;
            var checkStatus = table.checkStatus('test')
                , data = checkStatus.data;
            if (data.length > 0) {
                $(".btngroup").removeClass("layui-hide");
            } else {
                $(".btngroup").addClass("layui-hide");
            }
        });
        table.on('sort(tableTest)', function (obj) { //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
            console.log(obj.field); //当前排序的字段名
            console.log(obj.type); //当前排序类型：desc（降序）、asc（升序）、null（空对象，默认排序）
            console.log(this); //当前排序的 th 对象
            var _o = this;
            table.reload('test', {
                initSort: obj.field //记录初始排序，如果不设的话，将无法标记表头的排序状态。 layui 2.1.1 新增参数
                , url: "getfile"
                , where: { //请求参数（注意：这里面的参数可任意定义，并非下面固定的格式）
                    field: obj.field //排序字段
                    , order: obj.type, //排序方式
                    path: jQuery("#filepath").val(),
                    type: jQuery("#type").val(),
                    search: jQuery("#search").val(),
                    token: jQuery("#token").val()
                }, done: function (res) {
                    console.log(res)
                    $(_o).find('.layui-table-sort-' + obj.type).css("border-top-color", "#666");
                    //newArr = res.data;
                }
            });
        });
        //监听工具条
        table.on('tool(tableTest)', function (obj) {
            var data = obj.data;
            if (obj.event === 'yes') {
                var childInput = obj.tr[0].childNodes[1].childNodes[0].childNodes[1].childNodes[3].value;

                data.Name = childInput;
                newArr.push(data)
                newArr.forEach(function (element, i) {
                    if (element.Name == "new") {
                        newArr.splice(i, 1);
                    }
                });

                // 表格重载
                table.reload('test', {
                    url: "NewFile",
                    where: {
                        path: jQuery("#filepath").val() + "/" + childInput
                    },
                    done: function (res) {
                        if (res.code == "0") {
                            //location.reload();
                            tableLayui();
                        } else {
                            $layer.msg('失败', function () {
                                obj.del();
                                newContent = {};
                            });
                        }
                    }
                });
            } else if (obj.event === 'no') {
                obj.del();
                newContent = {};
            } else if (obj.event === 'sure') {
                var newName = $(this).siblings(".newFile").val();
                console.log(data)
                console.log(newName)

                $.ajax({
                    type: "Post",
                    url: "rename",
                    data: {
                        orignFile: data.FileUrl,
                        newFile: newName
                    },
                    success: function (data) {
                        var res = JSON.parse(data);
                        console.log(res);
                        if (res.code == "200") {
                            //location.reload();
                            tableLayui()
                        } else {
                            $layer.msg(res.msg, function () {
                                var _oht = '<div class="layui-table-cell laytable-cell-1-name">'
                                    + '<span><img src="' + imgSrc + '" alt="">' + oldName + '</span>' +
                                    '<span class="toolBar fr"><i class="layui-icon">&#xe65f;</i></span>' +
                                    '<ul class="toolList">' +
                                    '<li class="down">下载</li>' +
                                    '<li class="delete">删除</li>' +
                                    '</ul>'
                                    + '</div>';
                                $(".layui-table-body .layui-table tr").eq(trIndex)[0].children[1].innerHTML = _oht;
                            })

                        }
                    }
                })
                //var _oht = '<div class="layui-table-cell laytable-cell-1-name">'
                //    + '<span><img src="images/xls.png" alt="">' + newName + '</span>' +
                //    '<span class="toolBar fr"><i class="layui-icon">&#xe65f;</i></span>' +
                //    '<ul class="toolList">' +
                //    '<li>分享</li>' +
                //    '<li>下载</li>' +
                //    '<li>移动到</li>' +
                //    '<li>删除</li>' +
                //    '</ul>'
                //    + '</div>';
                //$(".layui-table-body .layui-table tr").eq(trIndex)[0].children[1].innerHTML = _oht;
                //$(".layui-table-body .layui-table tr").eq(trIndex)[0].children[1].dataset.content = newName;
            } else if (obj.event === 'cancel') {
                var _oht = '<div class="layui-table-cell laytable-cell-1-name">'
                    + '<span><img src="' + imgSrc + '" alt="">' + oldName + '</span>' +
                    '<span class="toolBar fr"><i class="layui-icon">&#xe65f;</i></span>' +
                    '<ul class="toolList">' +
                    '<li class="down">下载</li>' +
                    '<li class="delete">删除</li>' +
                    '</ul>'
                    + '</div>';
                $(".layui-table-body .layui-table tr").eq(trIndex)[0].children[1].innerHTML = _oht;
            }
        });
        var $ = layui.$, active = {
            sortName: function () {//按文件名排序
                // 监听排序
                table.reload('test', {
                    initSort: Name //记录初始排序，如果不设的话，将无法标记表头的排序状态。 layui 2.1.1 新增参数
                    , loading: true
                    , where: { //请求参数（注意：这里面的参数可任意定义，并非下面固定的格式）
                        field: Name.field //排序字段
                        , order: Name.type //排序方式
                    }
                });
            }
            , sortSize: function () { //按大小排序
                table.reload('test', {
                    initSort: Size //记录初始排序，如果不设的话，将无法标记表头的排序状态。 layui 2.1.1 新增参数
                    , where: { //请求参数（注意：这里面的参数可任意定义，并非下面固定的格式）
                        field: Size.field //排序字段
                        , order: Size.type //排序方式
                    }
                });
            }
            , sortDate: function () { //按日期排序
                table.reload('test', {
                    initSort: Date //记录初始排序，如果不设的话，将无法标记表头的排序状态。 layui 2.1.1 新增参数
                    , where: { //请求参数（注意：这里面的参数可任意定义，并非下面固定的格式）
                        field: Date.field //排序字段
                        , order: Date.type //排序方式
                    }
                });
            }
            , createFile: function () { //新建文件夹
                for (var i = 0; i < newArr.length; i++) {
                    if (newArr[i].Name == "new") {
                        newArr.splice(i, 1);
                    }
                }
                //新增的数据
                newContent.Name = 'new';
                newContent.size = '-';
                newContent.date = date;
                newArr.splice(50 * (currpage - 1), 0, newContent)
                // 表格重载
                table.reload('test', {
                    data: newArr,
                    limit: 100
                });
            },
            resetName: function () { //获取选中数据
                var checkStatus = table.checkStatus('test')
                    , data = checkStatus.data;

                if (data.length != 1) {
                    $layer.warning("一次可重命名一个文件");
                } else {
                    var trObj = $(".layui-table-body .layui-table tr").eq(trIndex)[0].children[1];
                    //ldName = $(".layui-table-body .layui-table tr").eq(trIndex)[0].children[1].dataset.content;
                    oldName = data[0].Name.split(">")[1].split("<")[0]
                    imgSrc = $(trObj).find("img").attr("src");
                    var _ht = '<div class="layui-table-cell laytable-cell-1-name">'
                        + '<span class="newCreatebox">'
                        + '<img src="' + imgSrc + '" alt="">'
                        + '<input type="text" value="' + oldName + '" class="newFile">'
                        + '<button class="layui-btn layui-btn-primary" lay-event="sure">'
                        + '<i class="layui-icon" style=" color: #1E9FFF;">&#xe605;</i>'
                        + '</button>'
                        + '<button class="layui-btn layui-btn-primary" lay-event="cancel">'
                        + '<i class="layui-icon" style="color: #1E9FFF;">&#x1006;</i>'
                        + '</button></span></div>';
                    $(".layui-table-body .layui-table tr").eq(trIndex)[0].children[1].innerHTML = _ht;
                }
            }

        };

        $('.menueList li').on('click', function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
        $('.table-top .layui-btn').on('click', function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
    }
    var trIndex;
    function tableLayui() {
        //$("#uploadBox").hide();
        layui.use('table', function () {
            var table = layui.table;
            var laypage = layui.laypage;
            var laydate = layui.laydate;
            var currpage = 1;
            //日期范围
            laydate.render({
                elem: '#r-search-date'
                , range: true
                , done: function (value, date, endDate) {

                    $("#start").val(new Date(date.year, date.month - 1, date.date).toLocaleDateString());
                    $("#end").val(new Date(endDate.year, endDate.month - 1, endDate.date).toLocaleDateString());
                }
            });
            jQuery.ajax({
                type: "Post",
                url: "getfile",
                data: {
                    path: jQuery("#filepath").val(),
                    type: jQuery("#type").val(),
                    search: jQuery("#search").val(),
                    token: jQuery("#token").val()
                },
                success: function (data) {
                    tableData = data;
                    var res = JSON.parse(data);

                     newArr = res.data;
                    jQuery("#listcount").text("");
                    jQuery("#listcount").text(res.count);
                    var newContent = new Object();
                    //获取当前系统日期
                    var mydate = new Date();
                    var date = "" + mydate.getFullYear() + "-";
                    date += (mydate.getMonth() + 1) + "-";
                    date += mydate.getDate();

                    //选中的第几行
                    var oldName, imgSrc;

                    if (newArr.length > 50) {
                        //表格
                        table.render({
                            elem: '#test'
                            , data: newArr
                            , page: {

                                layout: ['count', 'prev', 'page', 'next']
                                , prev: '上一页'
                                , next: '下一页'
                                , count: newArr.length
                                , limit: 50
                                , theme: '#1E9FFF'
                            }


                            , cols: [[
                                { type: 'checkbox' }
                                , { field: 'Name', width: '50%', title: '文件名', sort: true, templet: '#fileName' }
                                , { field: 'Size', title: '大小', sort: true, align: 'center' }
                                , { field: 'Date', title: '修改日期', sort: true, align: 'center' }

                            ]]

                            , done: function (res, curr, count) {
                                currpage = curr;
                                if (res.count == 0) {
                                    jQuery("#noData").removeClass("layui-hide");
                                    jQuery(".layui-none").remove();
                                    jQuery(".layui-table-page").remove();
                                } else {

                                    jQuery("#noData").addClass("layui-hide");
                                }
                            }
                            , id: "test"
                        });
                    }
                    else {
                        //表格
                        table.render({
                            elem: '#test'
                            , data: newArr
                            , limit: 50
                            , cols: [[
                                { type: 'checkbox' }
                                , { field: 'Name', width: '50%', title: '文件名', sort: true, templet: '#fileName' }
                                , { field: 'Size', title: '大小', sort: true }
                                , { field: 'Date', title: '修改日期', sort: true, align: 'center' }

                            ]]

                            , done: function (res) {

                                if (res.count == 0) {
                                    jQuery("#noData").removeClass("layui-hide");
                                    jQuery(".layui-none").remove();
                                    jQuery(".layui-table-page").remove();
                                } else {

                                    jQuery("#noData").addClass("layui-hide");
                                }
                            }
                            , id: "test"
                        });

                    }
                    jQuery("td[data-field='Name'] a").mouseover(function () {
                        var that = this;
                        var text = $(that).text();
                        var t_w = $(that).width();
                        var w = $(that).parent().width();
                        if (t_w > w*0.9) {
                            layer.tips(text, that, {tips:3,time:4000}); 
                        }
                    })
                    var trs = [];
                    //监听表格复选框选择
                    table.on('checkbox(tableTest)', function (obj) {
                        if (obj.checked) {
                            //trIndex = obj.data.LAY_TABLE_INDEX;
                            trs.push(obj.data.LAY_TABLE_INDEX);
                        } else {
                            for (var i = 0; i < trs.length; i++) {
                                if (obj.data.LAY_TABLE_INDEX == trs[i]) {
                                    trs.splice(i, 1);
                                }
                            }
                        }
                        trIndex = trs[0]||-1;
                        var checkStatus = table.checkStatus('test')
                            , data = checkStatus.data;
                        if (data.length > 0) {
                            $(".btngroup").removeClass("layui-hide");
                        } else {
                            $(".btngroup").addClass("layui-hide");
                        }
                    });
                    table.on('sort(tableTest)', function (obj) { //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
                        console.log(obj.field); //当前排序的字段名
                        console.log(obj.type); //当前排序类型：desc（降序）、asc（升序）、null（空对象，默认排序）
                        console.log($(this)[0].cellIndex); //当前排序的 th 对象
                        var th_i = $(this)[0].cellIndex-1;
                        table.reload('test', {
                            initSort: obj.field //记录初始排序，如果不设的话，将无法标记表头的排序状态。 layui 2.1.1 新增参数
                            , url: "getfile"
                            , where: { //请求参数（注意：这里面的参数可任意定义，并非下面固定的格式）
                                field: obj.field //排序字段
                                , order: obj.type, //排序方式
                                path: jQuery("#filepath").val(),
                                type: jQuery("#type").val(),
                                search: jQuery("#search").val(),
                                token: jQuery("#token").val()
                            }, done: function (res) {
                                console.log("====================")
                                if (obj.type == 'asc') {
                                    $('.layui-table-sort-' + obj.type).eq(th_i).addClass("asc");
                                } else {
                                    $('.layui-table-sort-' + obj.type).eq(th_i).addClass("desc");
                                }
                               
                                //newArr = res.data;
                            }
                        });
                        
                    });
                    //监听工具条
                    table.on('tool(tableTest)', function (obj) {
                        var data = obj.data;
                        if (obj.event === 'yes') {
                            var childInput = obj.tr[0].childNodes[1].childNodes[0].childNodes[1].childNodes[3].value||'新建文件夹';
                            reg = /[\/:*?"<>|%]/im;
                            if (reg.test(childInput)) {
                                $layer.warning("不能包含非法字符")
                                return;
                            }
                            data.Name = childInput;
                            newArr.push(data)
                            newArr.forEach(function (element, i) {
                                if (element.Name == "new") {
                                    newArr.splice(i, 1);
                                }
                            });

                            // 表格重载
                            table.reload('test', {
                                url: "NewFile",
                                where: {
                                    path: jQuery("#filepath").val() + "/" + childInput
                                },
                                done: function (res) {
                                    if (res.code == "0") {
                                        tableLayui()
                                    } else {
                                        $layer.msg('失败', function () {
                                            obj.del();
                                            newContent = {};
                                        });
                                    }
                                }
                            });
                        } else if (obj.event === 'no') {
                            obj.del();
                            newContent = {};
                        } else if (obj.event === 'sure') {
                            var newName = $(this).siblings(".newFile").val();
                            console.log(data)
                            console.log(newName)
                            reg = /[\/:*?"<>|%]/im;
                            if (reg.test(newName)) {
                                $layer.warning("不能包含非法字符")
                                return;
                            }
                            $.ajax({
                                type: "Post",
                                url: "rename",
                                data: {
                                    orignFile: data.FileUrl,
                                    newFile: newName
                                },
                                success: function (data) {
                                    var res = JSON.parse(data);
                                    console.log(res);
                                    if (res.code == "200") {
                                        tableLayui()
                                    } else {
                                        $layer.msg(res.msg, function () {
                                            var _oht = '<div class="layui-table-cell laytable-cell-1-name">'
                                                + '<span><img src="' + imgSrc + '" alt="">' + oldName + '</span>' +
                                                '<span class="toolBar fr"><i class="layui-icon">&#xe65f;</i></span>' +
                                                '<ul class="toolList">' +
                                                '<li class="down">下载</li>' +
                                                '<li class="delete">删除</li>' +
                                                '<li class="renameFile" lay-event="renameFile">重命名</li>' +
                                                '</ul>'
                                                + '</div>';
                                            $(".layui-table-body .layui-table tr").eq(trIndex)[0].children[1].innerHTML = _oht;
                                        })

                                    }
                                }
                            })

                        } else if (obj.event === 'cancel') {
                            tableLayui()

                        } else if (obj.event === 'renameFile') {
                            trIndex = obj.tr[0].sectionRowIndex;
                            var trObj = $(this).parent().parent().parent();
                            //ldName = $(".layui-table-body .layui-table tr").eq(trIndex)[0].children[1].dataset.content;
                            oldName = data.Name.split(">")[1].split("<")[0]
                            imgSrc = $(trObj).find("img").attr("src");
                            var _ht = '<div class="layui-table-cell laytable-cell-1-name">'
                                + '<span class="newCreatebox">'
                                + '<img src="' + imgSrc + '" alt="">'
                                + '<input type="text" value="' + oldName + '" class="newFile">'
                                + '<button class="layui-btn layui-btn-primary" lay-event="sure">'
                                + '<i class="layui-icon" style=" color: #1E9FFF;">&#xe605;</i>'
                                + '</button>'
                                + '<button class="layui-btn layui-btn-primary" lay-event="cancel">'
                                + '<i class="layui-icon" style="color: #1E9FFF;">&#x1006;</i>'
                                + '</button></span></div>';
                            $(".layui-table-body .layui-table tr").eq(trIndex)[0].children[1].innerHTML = _ht;

                        }
                    });
                    var $ = layui.$, active = {
                        sortName: function () {//按文件名排序
                            // 监听排序
                            table.reload('test', {
                                initSort: Name //记录初始排序，如果不设的话，将无法标记表头的排序状态。 layui 2.1.1 新增参数
                                , loading: true
                                , where: { //请求参数（注意：这里面的参数可任意定义，并非下面固定的格式）
                                    field: Name.field //排序字段
                                    , order: Name.type //排序方式
                                }
                            });
                        }
                        , sortSize: function () { //按大小排序
                            table.reload('test', {
                                initSort: Size //记录初始排序，如果不设的话，将无法标记表头的排序状态。 layui 2.1.1 新增参数
                                , where: { //请求参数（注意：这里面的参数可任意定义，并非下面固定的格式）
                                    field: Size.field //排序字段
                                    , order: Size.type //排序方式
                                }
                            });
                        }
                        , sortDate: function () { //按日期排序
                            table.reload('test', {
                                initSort: Date //记录初始排序，如果不设的话，将无法标记表头的排序状态。 layui 2.1.1 新增参数
                                , where: { //请求参数（注意：这里面的参数可任意定义，并非下面固定的格式）
                                    field: Date.field //排序字段
                                    , order: Date.type //排序方式
                                }
                            });
                        }
                        , createFile: function () { //新建文件夹
                            for (var i = 0; i < newArr.length; i++) {
                                if (newArr[i].Name == "new") {
                                    newArr.splice(i, 1);
                                }
                            }
                            console.log(newArr)
                            //新增的数据
                            newContent.Name = 'new';
                            newContent.size = '-';
                            newContent.date = date;
                            newArr.splice(50 * (currpage - 1), 0, newContent)
                            console.log(newArr)
                            // 表格重载
                            //table.reload('test', {
                            //    data: newArr,
                            //    limit: 100
                            //});
                            table.render({
                                elem: '#test'
                                , data: newArr
                                , limit: 50
                                , cols: [[
                                    { type: 'checkbox' }
                                    , { field: 'Name', width: '50%', title: '文件名', sort: true, templet: '#fileName' }
                                    , { field: 'Size', title: '大小', sort: true }
                                    , { field: 'Date', title: '修改日期', sort: true, align: 'center' }

                                ]]
                            });
                        },
                        resetName: function (obj) { //获取选中数据
                            var checkStatus = table.checkStatus('test')
                                , data = checkStatus.data;
                            layui.form.render();
                            if (data.length != 1) {
                                layer.msg("一次可重命名一个文件");
                            } else {
                                var trObj = $(".layui-table-body .layui-table tr").eq(trIndex)[0].children[1];
                                //ldName = $(".layui-table-body .layui-table tr").eq(trIndex)[0].children[1].dataset.content;
                                oldName = data[0].Name.split(">")[1].split("<")[0]
                                imgSrc = $(trObj).find("img").attr("src");
                                var _ht = '<div class="layui-table-cell laytable-cell-1-name">'
                                    + '<span class="newCreatebox">'
                                    + '<img src="' + imgSrc + '" alt="">'
                                    + '<input type="text" value="' + oldName + '" class="newFile">'
                                    + '<button class="layui-btn layui-btn-primary" lay-event="sure">'
                                    + '<i class="layui-icon" style=" color: #1E9FFF;">&#xe605;</i>'
                                    + '</button>'
                                    + '<button class="layui-btn layui-btn-primary" lay-event="cancel">'
                                    + '<i class="layui-icon" style="color: #1E9FFF;">&#x1006;</i>'
                                    + '</button></span></div>';
                                $(".layui-table-body .layui-table tr").eq(trIndex)[0].children[1].innerHTML = _ht;
                            }
                        }

                    };
                    //$(document).on("click", ".renameFile", function () {
                    //    console.log("fksdjflksklsdkl")
                    //    var checkStatus = table.checkStatus('test')
                    //        , data = checkStatus.data;
                    //    trIndex = 0;
                    //    //var trObj = $(".layui-table-body .layui-table tr").eq(trIndex)[0].children[1];
                    //    var trObj = $(this).parent().parent().parent();
                    //    //ldName = $(".layui-table-body .layui-table tr").eq(trIndex)[0].children[1].dataset.content;
                    //    oldName = data[0].Name.split(">")[1].split("<")[0]
                    //    imgSrc = $(trObj).find("img").attr("src");
                    //    var _ht = '<div class="layui-table-cell laytable-cell-1-name">'
                    //        + '<span class="newCreatebox">'
                    //        + '<img src="' + imgSrc + '" alt="">'
                    //        + '<input type="text" value="' + oldName + '" class="newFile">'
                    //        + '<button class="layui-btn layui-btn-primary" lay-event="sure">'
                    //        + '<i class="layui-icon" style=" color: #1E9FFF;">&#xe605;</i>'
                    //        + '</button>'
                    //        + '<button class="layui-btn layui-btn-primary" lay-event="cancel">'
                    //        + '<i class="layui-icon" style="color: #1E9FFF;">&#x1006;</i>'
                    //        + '</button></span></div>';
                    //    $(".layui-table-body .layui-table tr").eq(trIndex)[0].children[1].innerHTML = _ht;
                    //})
                    $('.menueList li').on('click', function () {
                        var type = $(this).data('type');
                        active[type] ? active[type].call(this) : '';
                    });
                    $('.table-top .layui-btn').on('click', function () {
                        var type = $(this).data('type');
                        active[type] ? active[type].call(this) : '';
                    });

                    //预览文档
                    //$("td[data-field='Name'] span[data-type!='1']").off().on("click", function () {
                    //    own.loading.show();
                    //    var that = this;
                    //    var fileurl = $(that).data("fileurl");
                    //    $.ajax({
                    //        type: "POST",
                    //        url: "/home/GetAsposeOfficeFiles",
                    //        data: { filePath: fileurl },
                    //        //contentType: "application/json; charset=utf-8",
                    //        dataType: "json",
                    //        success: function (result) {
                    //            own.loading.hide();
                    //            console.log(result);
                    //            if (result.code == '200') {
                    //                layer.open({
                    //                    type: 2,
                    //                    title: '',
                    //                    offset: ['0px', '0px'],
                    //                    shadeClose: true,
                    //                    shade: 0.8,
                    //                    area: ['100%', '100%'],
                    //                    content: result.msg //iframe的url
                    //                });
                    //            } else if (result.code == '40001') {
                    //                $layer.warning(result.msg);
                    //            } else {
                    //                $layer.warning("服务器错误");
                    //            }
                                
                    //        }
                    //    })
                    //})

                }
            });
        });
    }
    
    $(function () {
        $(document).on("click", "td[data-field='Name'] span[data-type!='1'] a", function () {
            own.loading.show();
            var that = this;
            var fileurl = $(that).parent().data("fileurl");
            $.ajax({
                type: "POST",
                url: "/home/GetAsposeOfficeFiles",
                data: { filePath: fileurl },
                //contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (result) {
                    own.loading.hide();
                    console.log(result);
                    if (result.code == '200') {
                        layer.open({
                            type: 2,
                            title: '',
                            offset: ['0px', '0px'],
                            shadeClose: true,
                            shade: 0.8,
                            area: ['100%', '100%'],
                            content: result.msg //iframe的url
                        });
                        $(".layui-layer-setwin .layui-layer-close2").css({ right: "3px", top: "-14px" });
                    } else if (result.code == '40001') {
                        $layer.warning(result.msg);
                    } else {
                        $layer.warning("服务器错误");
                    }

                }
            })
        })
        $("#test1").off().on("click", function () {
            own.loading.show();
            $.ajax({
                type: "POST",
                url: "/home/GetAsposeOfficeFiles",
                data: '',
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (result) {
                    own.loading.hide();
                    console.log(result);
                    //var officeInternetView = result[0];
                    var viewUrl = result[1];
                    var pageView = result[2];
                    var tempPage = result[3];
                    layer.open({
                        type: 2,
                        title: 'layer mobile页',
                        offset: ['0px', '0px'],
                        shadeClose: true,
                        shade: 0.8,
                        area: ['100%', '100%'],
                        content: "/File/f4b2b995ac414623b779467f8a8f5946/head.png" //iframe的url
                    });
                    //var paging = $("#paging");
                    //if (pageView === "True") {
                    //    paging[0].style.display = "block";
                    //    $("#page-nav")[0].value = tempPage;
                    //} else {
                    //    paging[0].style.display = "none";
                    //}
                    //$("#CurrentDocumentPage").attr("src", viewUrl);
                }
            })
        })
        if ($("#person", window.parent.document).length > 0) {
            $(".btnsWrap").hide();
            $("#shareBtn").show();
        }
        //隐藏新建文件夹按钮
        if ($("#type").val()) {
            $(".cf").addClass("layui-hide");
            $("#picker").addClass("layui-hide");
        }
        $("#menue").mouseenter(function () {
            $(".menueBox").show();
        });
        $(".menueBox").mouseleave(function () {
            $(".menueBox").hide();
        });
        $(".menueList li").click(function () {
            $(this).css("color", "#1E9FFF");
            $(this).find("i").show();
            $(this).siblings().find("i").hide();
            $(this).siblings().css("color", "#4c4c4c");
        });
        //表格行划过出现工具图标
        $(document).on("mouseenter", ".layui-table tr", function () {
            $(this).find(".toolBar").show();
        })
        $(".layui-table tr").mouseenter(function () {
            $(this).find(".toolBar").show();
        });
        $(document).on("mouseleave", ".layui-table tr", function () {
            $(this).find(".toolBar").hide();
            $(this).find(".toolList").hide();
        })
        $(".layui-table tr").mouseleave(function () {
            $(this).find(".toolBar").hide();
            $(this).find(".toolList").hide();
        });
        //工具图标点击
        $(document).on("click", ".toolBar", function (e) {
            $(this).siblings(".toolList").show();
        })
        $(".toolBar").click(function () {
            $(this).siblings(".toolList").show();
        });
        $(document).on("click", ".toolList li", function () {
            $(this).addClass("active").siblings().removeClass("active");
        })
        $(".toolList li").click(function () {
            $(this).addClass("active").siblings().removeClass("active");
        });
        //选中人员并分享
        var a = "成功";
        $("#shareBtn").click(function () {
            var peopleName = localStorage.getItem("peopleNames");
            if (!peopleName) {
                layer.msg("请选择要分享的人");
                return;
            }
            var peopleNameJson = JSON.parse(peopleName);
            if (peopleNameJson.length == 0) {
                layer.msg("请选择要分享的人");
                return;
            }
            var table = layui.table;
            var checkStatus = table.checkStatus('test');
            if (checkStatus.data.length == 0) {
                layer.msg("请选择文件");
                return;
            }
            var filepaths = [];
            for (var i = 0; i < checkStatus.data.length; i++) {
                if (checkStatus.data[i].FileUrl) {
                    filepaths.push(checkStatus.data[i].FileUrl);

                }
            }
            console.log(filepaths)
            if (filepaths.length == 0) {
                layer.msg("请选择文件");
                return;
            }
            var data = {
                usersid: peopleName,
                filepath: JSON.stringify(filepaths)
            }
            $.ajax({
                type: "Post",
                url: "AddShare",
                data: {
                    usersid: peopleName,
                    filepath: JSON.stringify(filepaths)
                },
                success: function (data) {
                    console.log(data)
                    var res = JSON.parse(data);
                    if (res.code == "200") {
                        var alert = layer.alert('分享成功', function () {
                            $('#layui-layer1', parent.document).hide();
                            window.parent.location.reload(); //刷新父页面
                            layer.close(alert);
                        });
                    } else {
                        layer.msg('失败', function () {
                            //关闭后的操作
                        });
                    }
                }
            })

        });
        //搜索
        $(".searchBox i").off().on("click", function () {
            if ($("#search").val()) {
                $(".cf").addClass("layui-hide");
                $("#picker").addClass("layui-hide");
            } else {
                $(".cf").removeClass("layui-hide");
                $("#picker").removeClass("layui-hide");
            }
            var searchArr = [];
            $.ajax({
                type: "Post",
                url: "GetFile",
                data: {
                    search: $("#search").val()
                },
                success: function (data) {
                    var res = JSON.parse(data);
                    var table = layui.table;
                    if (res.data.length > 50) {
                        //表格
                        table.render({
                            elem: '#test'
                            , data: res.data
                            , page: {

                                layout: ['count', 'prev', 'page', 'next']
                                , prev: '上一页'
                                , next: '下一页'
                                , count: res.data.length
                                , limit: 50
                                , theme: '#1E9FFF'
                            }


                            , cols: [[
                                { type: 'checkbox' }
                                , { field: 'Name', width: 620, title: '文件名', sort: true, templet: '#fileName' }
                                , { field: 'Size', title: '大小', sort: true }
                                , { field: 'Date', title: '修改日期', sort: true }

                            ]]

                            , done: function (res) {

                                $("#listcount").text("");
                                $("#listcount").text(res.count);
                                if (res.data && res.data.length == 0) {
                                    $("#noData").removeClass("layui-hide");
                                } else {
                                    $("#noData").addClass("layui-hide");
                                }
                            }
                            , id: "test"
                        });
                    }
                    else {
                        //表格
                        table.render({
                            elem: '#test'
                            , data: res.data
                            , limit: 50
                            , cols: [[
                                { type: 'checkbox' }
                                , { field: 'Name', width: 620, title: '文件名', sort: true, templet: '#fileName' }
                                , { field: 'Size', title: '大小', sort: true }
                                , { field: 'Date', title: '修改日期', sort: true }

                            ]]

                            , done: function (res) {
                                $("#listcount").text("");
                                $("#listcount").text(res.count);
                                if (res.count == 0) {
                                    jQuery("#noData").removeClass("layui-hide");
                                    jQuery(".layui-none").remove();
                                    jQuery(".layui-table-page").remove();
                                } else {

                                    jQuery("#noData").addClass("layui-hide");
                                }

                            }
                            , id: "test"
                        });

                    }
                }
            })

        })
        
        //下载
        $(document).on("click", ".down", function () {
            var t = "";//文件类型1：文件夹  2：文件  3：多个文件
            var obj = $(this);
            var fu = obj.parent().prevAll("span").eq(1).data("fileurl");
            var fuType = obj.parent().prevAll("span").eq(1).data("type");
            var table = layui.table;
            var checkStatus = table.checkStatus('test');
            console.log(checkStatus)
            if (checkStatus.data.length == 1 && checkStatus.data[0].Type != "1" && false) {
                window.location.href = checkStatus.data[0].FileUrl;
            } else {
                var selectArr = [];
                if (fu) {
                    selectArr.push(fu);
                    if (fuType == "1") {
                        t = "1";
                    } else {
                        t = "2";
                    }
                } else {
                    for (var i = 0; i < checkStatus.data.length; i++) {
                        selectArr.push(checkStatus.data[i].FileUrl);
                    }
                    if (selectArr.length == 1) {
                        if (checkStatus.data[0].Type == "1") {
                            t = "1";
                        } else {
                            t = "2";
                        }
                    } else {
                        t = "3";
                    }
                }

                if (selectArr.length > 0) {
                    own.bg.show();
                    own.loading.show();
                    jQuery.ajax({
                        type: "Post",
                        url: "Export",
                        data: {
                            pathArr: JSON.stringify(selectArr)
                            , type: t
                        },
                        success: function (data, status, xhr) {
                            //parent.location.href = "/default/Export"
                            var res = JSON.parse(data);
                            console.log(res)
                            if (res.code == "200") {
                                own.loading.hide();
                                if (t == "2") {
                                    $layer.confirm('确定要下载该文件?',
                                        //{
                                        //    btn: ['下载', '取消'] //按钮
                                        //    , end: function () {
                                        //        delFile(res.data);
                                        //    }
                                        //},
                                        function () {
                                            $(".export-save-down").attr("href", res.data);
                                            $(".export-save-down").attr("download", "");
                                            $("#spd").trigger("click");
                                        }, function () {

                                        });
                                } else {
                                    $layer.confirm('文件夹将打包下载，确定要下载该文件夹吗？',
                                        //{
                                        //    btn: ['下载', '取消'] //按钮
                                        //    , end: function () {
                                        //        delFile(res.data);
                                        //    }
                                        //},
                                        function () {
                                            location.href = res.data;
                                        }, function () {

                                        });
                                }

                            }
                        }
                    })
                } else {
                    $layer.msg("请选择文件")
                }
            }

        })
        //删除
        $(document).on("click", ".delete", function () {
            var obj = $(this);
            var fu = obj.parent().prevAll("span").eq(1).data("fileurl");
            var table = layui.table;
            var checkStatus = table.checkStatus('test');
            var dataArr = [];
            if (fu) {
                dataArr.push(fu);
            } else {
                for (var i = 0; i < checkStatus.data.length; i++) {
                    dataArr.push(checkStatus.data[i].FileUrl)
                }
            }

            if (dataArr.length == 0) {
                $layer.msg("请选择文件")
                return;
            }
            $layer.confirm('确认删除吗？', function () {
                jQuery.ajax({
                    type: "Post",
                    url: "Recycle",
                    data: {
                        path: JSON.stringify(dataArr)
                    },
                    success: function (data, status, xhr) {
                        //parent.location.href = "/default/Export"
                        var res = JSON.parse(data);
                        if (res.code == "200") {
                            layer.close();
                            $(".btngroup").addClass("layui-hide");
                            tableLayui();
                        } else {
                            $layer.msg("删除失败");
                        }
                    }
                })
            }, function () {
            });
        })
        function delFile(p) {
            $.ajax({
                type: "Post",
                url: "delfile",
                data: {
                    path: p
                },
                success: function (data) {
                    //悄悄删除没有任何操作
                }
            })
        }


        //新加
        $(".show-btn").off().on("click", function () {
            $(".seach-right-box").animate({ right: "0px" }, 300, function () {
                $("#close-box").off().on("click", function () {
                    $(".seach-right-box").animate({ right: "-280px" }, 300)
                })
            })
        });

        $("#seacher-btn").off().on("click", function () {
            //window.frames['rightBox'].search($("#r-search").val());
            //seacher(); 搜索
            var s_name = $("#r-search-name").val()
            var s_date_start = $("#start").val();
            var s_date_end = $("#end").val();
            var s_type = $("#r-search-type").val()
            console.log(s_name, s_date_start, s_date_end, s_type)
            search(s_name, s_date_start, s_date_end, s_type);
        });

        $("#clean-btn").off().on("click", function () {
            $(".seacher-body").find(".s-input").val("")
        })

        //$(".share-btn").off().on("click", function () {
        //    localStorage.removeItem("peopleNames");
        //    var poepleBox = layer.open({
        //        id: "person",
        //        type: 1,
        //        area: [$(".right").offset().left - 10 - $(".left").offset().left + 50 + "px", '100%'], //宽高
        //        offset: ['60px', $(".left").offset().left - 50 + "px"],
        //        shade: 0,
        //        anim: 2,
        //        closeBtn: 1,
        //        title: false,
        //        content: $("#shareBox"),
        //        end: function () {
        //            $("#shareBox ul li").removeClass("active");
        //            $("#shareBox ul li").find("i").hide();
        //            $("#shareBox").hide();
        //            $("#rightBox").contents().find(".btnsWrap").show();
        //            $("#rightBox").contents().find("#shareBtn,.shareBtn").hide();
        //        }
        //    });
        //    //面包屑导航修改
        //    $("#rightBox").contents().find(".btnsWrap").hide();
        //    $("#rightBox").contents().find("#shareBtn,.shareBtn").show();

        //})
        //人员选择点击
        var peopleArr = [];
        $(document).on('click', '#shareBox .layui-colla-content>ul>li', function () {
            if ($(this).attr("class") == "active") {
                $(this).removeClass("active");
                $(this).find("i").hide();
                var people = $(this).find("span").data("userid");
                peopleArr.forEach(function (element, i) {
                    if (element == people) {
                        peopleArr.splice(i, 1);
                    }
                })
                console.log(peopleArr)
                localStorage.setItem("peopleNames", JSON.stringify(peopleArr));
            } else {
                $(this).addClass("active");
                $(this).find("i").show();
                var people = $(this).find("span").data("userid");
                peopleArr.push(people);
                console.log(peopleArr)
                localStorage.setItem("peopleNames", JSON.stringify(peopleArr));
            }
        });
        $("#search").off().on("click", function () {
            var search = $(this).prev("input").val();
            if (search) {
                $(this).parent().nextAll().find(".layui-colla-content").addClass("layui-show")
                $(this).parent().nextAll().find("li").removeClass("layui-hide");
                $(this).parent().nextAll().find("li").each(function (i) {
                    var str = $(this).find("span").text()
                    if (str.indexOf(search) == -1) {
                        $(this).addClass("layui-hide");
                    }
                })
            } else {
                $(this).parent().nextAll().find(".layui-colla-content").removeClass("layui-show")
                $(this).parent().nextAll().find("li").removeClass("layui-hide");
            }

        })
        //分类
        $("#typelist li").off().on("click", function () {
            var dd = $(this).data("guid");
            var token = getQueryString("token");//获取参数
            var tttttt = $("#token").val();
            if (dd == '0') {
                $(".export-save").attr("href", "/home/picture?token=" + tttttt);
                $("#sp").trigger("click");
            }
            if (dd == '1') {
                $(".export-save").attr("href", "/home/pageone?type=2&token=" + tttttt);
                $("#sp").trigger("click");
            }
            if (dd == '2') {
                $(".export-save").attr("href", "/home/pageone?type=0&token=" + tttttt);
                $("#sp").trigger("click");
            }
        })
        function setType() {
            var type = getQueryString("type");//获取参数
            $("#typelist li").removeClass("active");
            if (type == '2') {
                $("#typelist li[data-guid='1']").addClass("active");
            }
            if (type == '0') {
                $("#typelist li[data-guid='2']").addClass("active");
            }
        }
        setType();
        function getQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return unescape(r[2]);
            return null;
        }
        //弹出用户选择框
        var s_userids = [];
        $(".addVotePeople").off().on("click", function () {
            var _obj = $(document);
            var _left = (_obj.width() - 650) / 2, _top = (_obj.height() - 620 + _obj.scrollTop()) / 2;
            $("#shareBox").show().css({ "left": _left + "px", "top": 70 + "px" });
            own.bg.show();
            $(".close_cloose").off().on("click", function () {

                close();
            })
        })
        //点击部门展开部门人员
        $("#personlist>li>a").off().on("click", function () {
            var _obj = $(this);

            var _dd = _obj.siblings("div");
            if (_dd.css("display") == "none") {
                _obj.find("i").css({ "-webkit-transform": "rotate(90deg)", "left": "3px", "top": "-3px", "-moz-transform": "rotate(90deg)", "transform": "rotate(90deg)", "-ms-transform": "rotate(90deg)" });
                _dd.show();
            }
            else {
                _obj.find("i").css({ "-webkit-transform": "rotate(0deg)", "left": "0px", "top": "-0px", "-moz-transform": "rotate(0deg)", "transform": "rotate(0deg)", "-ms-transform": "rotate(0deg)" });
                _dd.hide();
            }
        });
        //左移
        $(document).on("click", "#personlist>li>div>span", function () {
            var _obj = $(this);
            var uid = $(_obj).data("uid");
            for (var i = 0; i < s_userids.length; i++) {
                if (uid == s_userids[i].uid) {
                    $layer.warning("右侧列表中已经存在");
                    return;
                }
            }
            s_userids.push({ uid: uid, uname: _obj.text() });
            $("#wrap ul").append("<li  data-uid='" + uid + "' data-type='" + $("#userType").val() + "'><a class='pl-10'>" + _obj.text() + "</a></li>");
        });
        //右移
        $(document).on("click", "#wrap>ul>li", function () {
            var _obj = $(this);
            var uid = _obj.data("uid");
            for (var i = 0; i < s_userids.length; i++) {
                if (uid == s_userids[i].uid) {
                    s_userids.splice(i, 1);
                    _obj.remove();
                    return;
                }
            }
        });
        //确定按钮
        $("#lay-confirm").off().on("click", function () {
            var peopleName = [];
            if (s_userids.length == 0) {
                $layer.warning("请选择要分享的人");
                return;
            }
            for (var i = 0; i < s_userids.length; i++) {
                peopleName.push(s_userids[i].uid);
            }
            var table = layui.table;
            var checkStatus = table.checkStatus('test');
            if (checkStatus.data.length == 0) {
                layer.msg("请选择文件");
                return;
            }
            var filepaths = [];
            for (var i = 0; i < checkStatus.data.length; i++) {
                if (checkStatus.data[i].FileUrl) {
                    filepaths.push(checkStatus.data[i].FileUrl);

                }
            }
            console.log(filepaths)
            if (filepaths.length == 0) {
                layer.msg("请选择文件");
                return;
            }
            var data = {
                usersid: JSON.stringify(peopleName),
                filepath: JSON.stringify(filepaths)
            }
            $.ajax({
                type: "Post",
                url: "AddShare",
                data: {
                    usersid: JSON.stringify(peopleName),
                    filepath: JSON.stringify(filepaths)
                },
                success: function (data) {
                    console.log(data)
                    var res = JSON.parse(data);
                    if (res.code == "200") {
                        close();
                        $layer.msg("分享成功");

                    } else {
                        layer.msg('失败', function () {
                            //关闭后的操作
                        });
                    }
                }
            })
        })
        function close() {
            s_userids = [];
            $("#wrap ul").html("");
            $("#shareBox").hide();
            own.bg.hide();
        }
        $("#keyword").keyup(function (e) {
            var key = $(this).val();
            var _obj = $("#personlist>li>a");
            var _dd = _obj.siblings("div");
            _dd.css("display", "none");
            if (_dd.css("display") == "none") {
                _obj.find("i").css({ "-webkit-transform": "rotate(90deg)", "left": "3px", "top": "-3px", "-moz-transform": "rotate(90deg)", "transform": "rotate(90deg)", "-ms-transform": "rotate(90deg)" });
                _dd.show();
            }
            else {
                _obj.find("i").css({ "-webkit-transform": "rotate(0deg)", "left": "0px", "top": "-0px", "-moz-transform": "rotate(0deg)", "transform": "rotate(0deg)", "-ms-transform": "rotate(0deg)" });
                _dd.hide();
            }
            $("#personlist>li>div>span").hide();
            $("#personlist>li>div>span:contains('" + key + "')").show();
        });
    })
    $(".clearfix").scroll(function () {   //页面加载时，获取滚动条初始高度
        var th = $(this).scrollTop();

        if (th > 60) {
            $(".table-top").addClass("fixednav");
        } else {
            $(".table-top").removeClass("fixednav");
        }

    })
    function search(s_name, s_date_start, s_date_end, s_type) {
        //if (search) {
        //    $(".cf").addClass("layui-hide");
        //} else {
        //    $(".cf").removeClass("layui-hide");
        //}
        $.ajax({
            type: "Post",
            url: "GetFile",
            data: {
                search: s_name
                , start: s_date_start
                , end: s_date_end
                , ftype: s_type
                ,token: jQuery("#token").val()
            },
            success: function (data) {
                var res = JSON.parse(data);
                var table = layui.table;
                if (res.data.length > 50) {
                    //表格
                    table.render({
                        elem: '#test'
                        , data: res.data
                        , page: {

                            layout: ['count', 'prev', 'page', 'next']
                            , prev: '上一页'
                            , next: '下一页'
                            , count: res.data.length
                            , limit: 50
                            , theme: '#1E9FFF'
                        }


                        , cols: [[
                            { type: 'checkbox' }
                            , { field: 'Name', width: 620, title: '文件名', sort: true, templet: '#fileName' }
                            , { field: 'Size', title: '大小', sort: true }
                            , { field: 'Date', title: '修改日期', sort: true }

                        ]]

                        , done: function (res) {

                            $("#listcount").text("");
                            $("#listcount").text(res.count);
                            if (res.data && res.data.length == 0) {
                                $("#noData").removeClass("layui-hide");
                            } else {
                                $("#noData").addClass("layui-hide");
                            }
                        }
                        , id: "test"
                    });
                }
                else {
                    //表格
                    table.render({
                        elem: '#test'
                        , data: res.data
                        , limit: 50
                        , cols: [[
                            { type: 'checkbox' }
                            , { field: 'Name', width: 620, title: '文件名', sort: true, templet: '#fileName' }
                            , { field: 'Size', title: '大小', sort: true }
                            , { field: 'Date', title: '修改日期', sort: true }

                        ]]

                        , done: function (res) {
                            $("#listcount").text("");
                            $("#listcount").text(res.count);
                            if (res.count == 0) {
                                jQuery("#noData").removeClass("layui-hide");
                                jQuery(".layui-none").remove();
                                jQuery(".layui-table-page").remove();
                            } else {

                                jQuery("#noData").addClass("layui-hide");
                            }

                        }
                        , id: "test"
                    });

                }
            }
        })

    }






</script>




